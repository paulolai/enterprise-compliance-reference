name: Executable Specs CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test-api:
    name: API Tests with Coverage
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Tests with Coverage
        working-directory: ./implementations/typescript-vitest
        run: pnpm test:coverage

      - name: Check Domain Coverage Threshold
        working-directory: ./implementations/typescript-vitest
        run: pnpm coverage:domain

      - name: Generate Allure Report
        working-directory: ./implementations/typescript-vitest
        run: pnpm test:allure && pnpm report:allure:generate

      - name: Upload Coverage Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: api-coverage
          path: implementations/typescript-vitest/coverage/
          retention-days: 30

      - name: Reorganize Allure Results for Upload
        if: always()
        run: |
          # create api/ subdirectory for compatibility with generate-attestation.cjs
          mkdir -p allure-results/api
          cp -r implementations/typescript-vitest/allure-results/* allure-results/api/ || true

      - name: Upload Allure Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-api
          path: allure-results/api/
          retention-days: 30

      - name: Generate API Attestation
        # Ensure report is generated even if tests fail
        if: always()
        working-directory: ./
        run: pnpm reports:attestation

      - name: Upload API Attestation Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: attestation-api
          path: reports/
          retention-days: 30

      - name: Display API Attestation Summary
        if: always()
        working-directory: ./
        run: |
          ATTESTATION=$(find reports -name "attestation.md" | tail -1)
          if [ -n "$ATTESTATION" ]; then
            echo "## ðŸ“Š API Attestation Report" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            cat "$ATTESTATION" >> $GITHUB_STEP_SUMMARY
          fi

  test-gui:
    name: GUI Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Get Playwright Browsers Cache Key
        id: playwright-cache-key
        working-directory: ./implementations/react-playwright
        run: echo "key=$(pnpm exec playwright --version)" >> $GITHUB_OUTPUT

      - name: Cache Playwright Browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ steps.playwright-cache-key.outputs.key }}-chromium

      - name: Install Playwright Browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        working-directory: ./implementations/react-playwright
        run: pnpm exec playwright install --with-deps chromium

      - name: Type Check
        working-directory: ./implementations/react-playwright
        run: pnpm exec tsc --noEmit

      - name: Lint
        working-directory: ./implementations/react-playwright
        run: pnpm lint

      - name: Run Playwright Tests
        working-directory: ./implementations/react-playwright
        run: pnpm test

      - name: Upload Playwright Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: implementations/react-playwright/playwright-report/
          retention-days: 7

      - name: Upload Playwright Traces
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-traces
          path: implementations/react-playwright/test-results/
          retention-days: 7

      - name: Upload Allure GUI Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-gui
          path: allure-results/gui/
          retention-days: 30

  generate-reports:
    name: Generate Unified Reports
    runs-on: ubuntu-latest
    needs: [test-api, test-gui]
    if: always()

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Download All Outputs
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Merge Allure Results
        run: |
          # Create merged directory structure expected by generate-attestation.cjs
          mkdir -p allure-results/api
          mkdir -p allure-results/gui
          # Check if directories exist before copying to avoid errors if one job failed completely
          if [ -d "artifacts/allure-api" ]; then
            cp -r artifacts/allure-api/* allure-results/api/ 2>/dev/null || true
          fi
          if [ -d "artifacts/allure-gui" ]; then
            cp -r artifacts/allure-gui/* allure-results/gui/ 2>/dev/null || true
          fi

      - name: Generate Unified Attestation
        if: always()
        run: pnpm reports:attestation

      - name: Generate Overall Allure Report
        if: always()
        run: |
          # Merge both api and gui results for the Allure HTML report
          mkdir -p merged-allure-results
          if [ -d "allure-results/api" ]; then
            cp -r allure-results/api/* merged-allure-results/ 2>/dev/null || true
          fi
          if [ -d "allure-results/gui" ]; then
            cp -r allure-results/gui/* merged-allure-results/ 2>/dev/null || true
          fi

      - name: Generate Overall Allure HTML Report
        # Only run if we have results
        if: hashFiles('merged-allure-results/') != ''
        run: |
          pnpm exec allure generate merged-allure-results/ --clean --output allure-report/

      - name: Upload Unified Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unified-reports
          path: |
            reports/
            allure-report/
          retention-days: 30

      - name: Display Unified Attestation Summary
        if: always()
        run: |
          ATTESTATION=$(find reports -name "attestation.md" | tail -1)
          if [ -n "$ATTESTATION" ]; then
            echo "## ðŸ“‹ Unified Attestation Report" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            cat "$ATTESTATION" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Job Status Summary
        if: always()
        run: |
          echo "## ðŸ” Job Status Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| API Tests | ${{ needs.test-api.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| GUI Tests | ${{ needs.test-gui.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.test-api.result }}" != "success" ] || [ "${{ needs.test-gui.result }}" != "success" ]; then
            echo "âš ï¸ **One or more test jobs failed. Check the artifacts for details.**" >> $GITHUB_STEP_SUMMARY
          fi
